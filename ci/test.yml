.run_everything_rules: &run_everything_rules
  refs:
    - develop
    - releases
    - schedules
    - /^release\//

# @trezor/connect-popup (via @trezor/connect-explorer)
.e2e connect-popup:
  stage: integration testing
  retry: 1
  variables:
    COMPOSE_PROJECT_NAME: $CI_JOB_ID
    COMPOSE_FILE: ./docker/docker-compose.connect-popup-ci.yml
    URL: ${DEV_SERVER_URL}/connect/${CI_COMMIT_REF_NAME}/
    TEST_FILE: $TEST_FILE
  script:
    - yarn install --immutable
    - docker-compose pull
    - docker-compose up -d trezor-user-env-unix
    - docker-compose run test-run
  after_script:
    - docker-compose down
    - docker network prune -f
  artifacts:
    expire_in: 7 days
    when: always
    paths:
      - ./packages/connect-popup/e2e/screenshots
      - ./packages/connect-popup/connect-popup-overview.html
      - ./packages/connect-popup/test-results
  interruptible: true
  parallel:
    matrix:
      - TEST_FILE: ["methods"]
      - TEST_FILE: ["popup-close"]
      - TEST_FILE: ["popup-error-page"]
      - TEST_FILE: ["passphrase"]
      - TEST_FILE: ["unchained"]
      - TEST_FILE: ["browser-support"]
      - TEST_FILE: ["install-bridge"]

connect-popup:
  extends: .e2e connect-popup
  dependencies:
    - install
    - connect-web build
  only:
    <<: *run_everything_rules

connect-popup manual:
  extends: .e2e connect-popup
  needs:
    - install
    - connect-web build
  except:
    <<: *run_everything_rules
  when: manual

connect-popup legacy:
  extends: .e2e connect-popup
  retry: 0
  variables:
    COMPOSE_PROJECT_NAME: $CI_JOB_ID
    COMPOSE_FILE: ./docker/docker-compose.connect-popup-ci.yml
    URL: ${DEV_SERVER_URL}/connect/npm-release/connect-${CONNECT_VERSION}/?trezor-connect-src=${DEV_SERVER_URL}/connect/${CI_COMMIT_REF_NAME}/
    # https://suite.corp.sldev.cz/connect/npm-release/connect-9.0.10/#/
    TEST_FILE: $TEST_FILE
  parallel:
    matrix:
      - CONNECT_VERSION: "9.0.10"
        TEST_FILE: ["methods", "popup-close", "browser-support"]
  # only:
  #   <<: *run_everything_rules
